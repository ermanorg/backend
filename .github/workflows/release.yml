name: Release


on:
 workflow_dispatch:
   inputs:
     release:
       description: 'Trigger release after training?'
       required: false
       default: 'true'


jobs:
 train:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@v3
     - uses: actions/setup-python@v4
       with:
         python-version: '3.x'
     - run: pip install -r requirements.txt
     - run: python train.py | tee train_output.txt
     - name: Upload checkpoint
       uses: actions/upload-artifact@v4
       with:
         name: checkpoint
         path: checkpoint.pkl
     - name: Upload output log
       uses: actions/upload-artifact@v4
       with:
         name: train_output
         path: train_output.txt


 release:
   needs: train
   if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true' }}
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@v3
     - name: Download artifact (checkpoint)
       uses: actions/download-artifact@v4
       with:
         name: checkpoint
         path: .
     - name: Download train output
       uses: actions/download-artifact@v4
       with:
         name: train_output
         path: .
     - name: Create Release
       id: create_release
       uses: actions/create-release@v1
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
       with:
         tag_name: v${{ github.run_number }}
         release_name: "Model checkpoint ${{ github.run_number }}"
         body_path: train_output.txt
         draft: false
         prerelease: false
     - name: Upload checkpoint to Release
       uses: actions/upload-release-asset@v1
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
       with:
         upload_url: ${{ steps.create_release.outputs.upload_url }}
         asset_path: ./checkpoint.pkl
         asset_name: checkpoint.pkl
         asset_content_type: application/octet-stream


permissions:
 contents: write
